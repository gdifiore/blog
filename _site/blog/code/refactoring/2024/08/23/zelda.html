<p>This post details some thoughts I had when looking over some code I wrote for a <a href="https://github.com/CSE3902-Group-3/CSE3902-TheLegendOfZelda-Remake">university assignment</a> (a remake of the original NES Legend of Zelda).</p>

<p>I won’t be pushing any of these changes, but I thought it would be a good test of what I have learned, and an exercise in how I would approach refactoring code I haven’t seen in a while (or ever).</p>

<h2 id="too-many-variables">Too many variables</h2>

<p>The <code class="language-plaintext highlighter-rouge">Link</code> class ended up needing to manage 3 different positions:</p>

<ol>
  <li>the position of the current sprite (used for drawing)</li>
  <li>the position of the collider (used to resolve colisions)</li>
  <li>the position stored in the state machine (used for movement)</li>
</ol>

<p>My solution was to write the following utility function:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// LinkUtilities.cs</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">UpdatePositions</span><span class="p">(</span><span class="n">Link</span> <span class="n">link</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">newPositon</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">link</span><span class="p">.</span><span class="n">Sprite</span><span class="p">.</span><span class="nf">UpdatePos</span><span class="p">(</span><span class="n">newPositon</span><span class="p">);</span>
    <span class="n">link</span><span class="p">.</span><span class="n">StateMachine</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">newPositon</span><span class="p">;</span>
    <span class="n">link</span><span class="p">.</span><span class="n">Collider</span><span class="p">.</span><span class="n">Pos</span> <span class="p">=</span> <span class="n">newPositon</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It’s a fine solution, I guess, but it’s not in line with the other calling conventions of <code class="language-plaintext highlighter-rouge">Link</code>-related variables. Consistency makes it easier for others to pick up your code. Cases like this are when it’s useful to understand design patterns that the language you’re using implements.</p>

<p>Enter, the <strong>Property Pattern</strong></p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Link.cs</span>
<span class="k">private</span> <span class="n">Vector2</span> <span class="n">position</span><span class="p">;</span>

<span class="k">public</span> <span class="n">Vector2</span> <span class="n">Position</span>
<span class="p">{</span>
    <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">position</span><span class="p">;</span>
    <span class="k">set</span>
    <span class="p">{</span>
        <span class="n">position</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
        <span class="n">Sprite</span><span class="p">.</span><span class="nf">UpdatePos</span><span class="p">(</span><span class="n">position</span><span class="p">);</span>
        <span class="n">StateMachine</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
        <span class="n">Collider</span><span class="p">.</span><span class="n">Pos</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Yes, this introduces one more variable to a semi-complicated class, but it makes updating the position way more consitent with other code.</p>

<p>Maybe a better refactor would to make all classes reference the <code class="language-plaintext highlighter-rouge">LinkStateMachine</code> position instead? But if you did not write/maintain another other class that uses a different position? That would introduce errors and/or bugs.</p>

<h2 id="unifying-responsibilities">Unifying responsibilities</h2>
<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Modified LinkCollisionWithItem.cs</span>
<span class="k">namespace</span> <span class="nn">LegendOfZelda</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">LinkCollisionWithItem</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">HandleCollisionWithItem</span><span class="p">(</span><span class="n">CollisionInfo</span> <span class="n">collision</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">IItem</span> <span class="n">itemCollidedWith</span> <span class="p">=</span> <span class="n">collision</span><span class="p">.</span><span class="n">CollidedWith</span><span class="p">.</span><span class="n">Collidable</span> <span class="k">as</span> <span class="n">IItem</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">itemCollidedWith</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>

            <span class="k">switch</span> <span class="p">(</span><span class="n">itemCollidedWith</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="n">Bow</span><span class="p">:</span>
                <span class="k">case</span> <span class="n">Triforce</span><span class="p">:</span>
                    <span class="n">Inventory</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">().</span><span class="nf">AddItem</span><span class="p">(</span><span class="n">itemCollidedWith</span><span class="p">);</span>
                    <span class="n">GameState</span><span class="p">.</span><span class="n">Link</span><span class="p">.</span><span class="n">StateMachine</span><span class="p">.</span><span class="nf">ChangeState</span><span class="p">(</span><span class="k">new</span> <span class="nf">CollectItemLinkState</span><span class="p">(</span><span class="n">itemCollidedWith</span><span class="p">));</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">...</span>
            <span class="p">}</span>

            <span class="c1">// Play sound only for specific items</span>
            <span class="k">if</span> <span class="p">(!(</span><span class="n">itemCollidedWith</span> <span class="k">is</span> <span class="n">Heart</span> <span class="p">||</span> <span class="n">itemCollidedWith</span> <span class="k">is</span> <span class="n">OneRupee</span> <span class="p">||</span> <span class="n">itemCollidedWith</span> <span class="k">is</span> <span class="n">FiveRupee</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">SoundFactory</span><span class="p">.</span><span class="nf">PlaySound</span><span class="p">(</span><span class="n">SoundFactory</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">().</span><span class="n">GetItem</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Why handle a bunch of <code class="language-plaintext highlighter-rouge">if-not</code> cases at the bottom? If <code class="language-plaintext highlighter-rouge">Heart</code>, <code class="language-plaintext highlighter-rouge">OneRupee</code>, and <code class="language-plaintext highlighter-rouge">FiveRupee</code> all handle sound on pickup, so should the other items!</p>

<p>This is where a concrete design before starting would be useful.</p>

<h2 id="trying-to-get-fancy">Trying to get fancy</h2>

<p><code class="language-plaintext highlighter-rouge">Utility/Config/ReadConfig.cs</code> contains a wrapper for reading from the config INI file that can be optionally edited.</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">; config.ini
</span><span class="nn">[Link]</span>
<span class="py">Speed</span><span class="p">=</span><span class="s">5</span>
<span class="py">Health</span><span class="p">=</span><span class="s">6</span>
<span class="py">ProjectileSpawnCooldown</span><span class="p">=</span><span class="s">1.5</span>

<span class="nn">[Enemies]</span>
<span class="c">; Easy damage multiplier = 0.5, Medium = 1; Hard = 2
</span><span class="py">Difficulty</span><span class="p">=</span><span class="s">Medium</span>

<span class="nn">[Game]</span>
<span class="py">Level</span><span class="p">=</span><span class="s">1</span>
</code></pre></div></div>

<p>I wanted to avoid calling every function individually:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GetLinkHealth</span><span class="p">();</span>
<span class="nf">GetLinkSpeed</span><span class="p">();</span>
<span class="nf">GetLinkProjectileSpawnCooldown</span><span class="p">();</span>
<span class="nf">GetDifficulty</span><span class="p">();</span>
<span class="nf">GetStartLevel</span><span class="p">();</span>
</code></pre></div></div>

<p>but in trying to be fancy with anonymous functions, I ended up creating something uglier:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ReadConfig.cs</span>
<span class="p">...</span>
        <span class="k">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">anonFunc</span><span class="p">();</span>
        <span class="k">private</span> <span class="n">anonFunc</span><span class="p">[]</span> <span class="n">anonFuncs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">anonFunc</span><span class="p">[</span><span class="n">numConfig</span><span class="p">];</span>

        <span class="p">...</span>
        <span class="k">public</span> <span class="nf">ReadConfig</span><span class="p">(</span><span class="kt">string</span> <span class="n">iniFilePath</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="p">...</span>
            <span class="n">anonFuncs</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">GetLinkSpeed</span><span class="p">;</span>
            <span class="n">anonFuncs</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">GetLinkHealth</span><span class="p">;</span>
            <span class="n">anonFuncs</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="n">GetLinkProjectileSpawnCooldown</span><span class="p">;</span>
            <span class="n">anonFuncs</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="n">GetDifficulty</span><span class="p">;</span>
            <span class="n">anonFuncs</span><span class="p">[</span><span class="m">4</span><span class="p">]</span> <span class="p">=</span> <span class="n">GetStartLevel</span><span class="p">;</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">func</span> <span class="k">in</span> <span class="n">anonFuncs</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">func</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">();</span>
            <span class="p">}</span>
<span class="p">...</span>
</code></pre></div></div>

<p>Why use anonymous functions here? I am doing almost the exact same thing I wanted to avoid.</p>

<p>All but one of those <code class="language-plaintext highlighter-rouge">ini</code> entries directly reads a float value, so why not create a generic function create a map of variables to the value from the ini?
<em>Difficulty would require a special function because the <code class="language-plaintext highlighter-rouge">ini</code> expects a string that gets mapped to a damage multiplier.</em></p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Modified ReadConfig.cs</span>
<span class="p">...</span>
        <span class="c1">// Mapping of config keys to the methods that handle them</span>
        <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">Action</span><span class="p">&gt;</span> <span class="n">configHandlers</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">ReadConfig</span><span class="p">(</span><span class="kt">string</span> <span class="n">iniFilePath</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="p">...</span>
            <span class="n">configHandlers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">Action</span><span class="p">&gt;</span>
            <span class="p">{</span>
                <span class="p">{</span> <span class="s">"Link.Speed"</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nf">GetConfigValue</span><span class="p">(</span><span class="s">"Link"</span><span class="p">,</span> <span class="s">"Speed"</span><span class="p">,</span> <span class="s">"Link.Speed"</span><span class="p">)</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"Link.Health"</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nf">GetConfigValue</span><span class="p">(</span><span class="s">"Link"</span><span class="p">,</span> <span class="s">"Health"</span><span class="p">,</span> <span class="s">"Link.Health"</span><span class="p">)</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"Link.ProjectileSpawnCooldown"</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nf">GetConfigValue</span><span class="p">(</span><span class="s">"Link"</span><span class="p">,</span> <span class="s">"ProjectileSpawnCooldown"</span><span class="p">,</span> <span class="s">"Link.ProjectileSpawnCooldown"</span><span class="p">)</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"Game.Difficulty"</span><span class="p">,</span> <span class="n">GetDifficulty</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"Game.Level"</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nf">GetConfigValue</span><span class="p">(</span><span class="s">"Game"</span><span class="p">,</span> <span class="s">"Level"</span><span class="p">,</span> <span class="s">"Game.Level"</span><span class="p">)</span> <span class="p">}</span>
            <span class="p">};</span>

            <span class="c1">// Execute each config handler</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">handler</span> <span class="k">in</span> <span class="n">configHandlers</span><span class="p">.</span><span class="n">Values</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">handler</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="p">...</span>
        <span class="p">}</span>

        <span class="p">...</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">GetConfigValue</span><span class="p">(</span><span class="kt">string</span> <span class="n">section</span><span class="p">,</span> <span class="kt">string</span> <span class="n">key</span><span class="p">,</span> <span class="kt">string</span> <span class="n">configKey</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="p">...</span>
        <span class="p">}</span>
<span class="p">...</span>
</code></pre></div></div>
<p>Much cleaner. New config values can be added in one line, rather than adding an entire new function. This is also more dynamic if the config file was to be changed to <code class="language-plaintext highlighter-rouge">JSON</code>, <code class="language-plaintext highlighter-rouge">GetConfigValue(...)</code>’s internals can be modified, but leaving the signature alone.</p>

<h2 id="what-causes-bad-designsimplementations">What causes bad designs/implementations?</h2>

<ol>
  <li>
    <p><strong>Time restraints</strong> <br />
This assignment was (among other things) designed for our groups to use sprint-planning. So there was always a quick turn around between tasks, as well as bug-fixes, tesing of other PRs, code reviews, etc. it was easy to just say “Oh this works, I’ll just push it to a PR”.
15 (really, 13) weeks is a quick turnaround for a project like this. Also, add on all the other classes, hobbies, and a social life and time starts to feel limited.</p>
  </li>
  <li>
    <p><strong>Lack of Knowledge</strong> <br />
This was the first large assignment that I had to start from scratch (albeit, with a group) and that’s very challenging the first time. The ability to pick the right design patterns, separate concerns, implement proper error handling are all things that were tested. And I certainly failed at first on some of those, but have learned and have a new outlook on design and implementation.</p>
  </li>
</ol>

<h2 id="lessons-learned">Lessons learned</h2>

<h4 id="design-design-design">Design, design, design</h4>
<p>Even if it takes 5 hours, designing and drawing relationships between clases and responsibilities can help identify potential complexity before you start coding.</p>

<p>You don’t need to write complete architecture or design documents, but map what’s in your mind onto paper.</p>

<h2 id="conclusion">Conclusion</h2>
<p>I think reviewing old code is a good idea for any software developer. You get to see if you’ve learned new skills or gained a new perspective on design. Everyone struggles to read old code, even if they wrote it. Exercise your brain, do things you think are challenging.</p>
